<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Activities List</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    .activity {
      background-color: #fff;
      padding: 15px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .activity h2 {
      margin: 0;
      font-size: 24px;
      cursor: pointer;
      color: #007BFF;
    }

    .activity h2:hover {
      text-decoration: underline;
    }

    .create-form, .update-form {
      display: none; /* Initially hidden */
      background-color: #f9f9f9;
      padding: 15px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .create-form input[type="text"],
    .create-form input[type="date"],
    .create-form input[type="time"],
    .update-form input[type="text"],
    .update-form input[type="date"],
    .update-form input[type="time"] {
      margin-bottom: 10px;
      padding: 8px;
      width: calc(100% - 20px);
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .create-form button,
    .update-form button,
    .toggle-button {
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }

    .create-form button:hover,
    .update-form button:hover,
    .toggle-button:hover {
      background-color: #0056b3;
    }

    .delete-button {
      background-color: red;
      color: white;
    }

    .delete-button:hover {
      background-color: darkred;
    }

    .update-button {
      background-color: orange;
      color: white;
      margin-left: 10px;
    }

    .update-button:hover {
      background-color: darkorange;
    }

    /* Styles for the Google Maps section */
    #map,
    #updateMap {
      height: 200px; /* Set height for small map */
      width: 100%; /* Set width for map */
      margin: 10px 0;
    }
  </style>
  <script
  async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjbAAKNhaUHHM7DmvEdWNVJqC2iDQtrG4&callback=initMap&libraries=places"
></script></head>
<body>

  <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tour Guide Itinerary</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    nav {
      background-color: #333;
      padding: 10px;
      margin-bottom: 20px;
    }

    nav a {
      color: white;
      text-decoration: none;
      padding: 10px;
      margin-right: 10px;
      display: inline-block;
    }

    nav a:hover {
      background-color: #575757;
      border-radius: 4px;
    }

    .itinerary {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .activity {
      margin: 10px 0;
    }

    .activity h3 {
      margin: 0;
    }

    .delete-button {
      background-color: #ff4d4d;
      color: white;
      border: none;
      padding: 8px;
      cursor: pointer;
      border-radius: 4px;
    }

    .delete-button:hover {
      background-color: #ff1a1a;
    }

    .update-form {
      display: none;
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .update-form input, .update-form select {
      width: 100%;
      margin: 5px 0;
      padding: 8px;
    }

    .update-button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px;
      cursor: pointer;
      border-radius: 4px;
    }

    .update-button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>



  

  <nav>
    <a>Advertiser</a>
    <a href="advertiserProfile.html">Profile</a>
    <a href="activities.html">Activities</a>
    <a href="Main.html">Back to Main Page</a>
  </nav>

  <h1>Activities List</h1>

  <div id="activityContainer">
    <!-- Activities will be loaded here -->
  </div>


  <button class="toggle-button" onclick="toggleCreateForm()">Create New Activity</button>
  <button onclick="fetchActivities()">Load Activities</button>

  <div id="createFormContainer" class="create-form">
    <h2>Create New Activity</h2>
    <input type="date" id="activityName" placeholder="Name">
    <input type="date" id="activityDate" placeholder="Date">
    <input type="time" id="activityTime" placeholder="Time">
    <input type="text" id="activityLocation" placeholder="Location (URL)">
    <button onclick="getCoordinates()">Get Coordinates</button> <!-- Button to get coordinates -->
    <div id="map"></div> <!-- Map div -->
    <input type="text" id="activityPrice" placeholder="Price"> <!-- Changed to text -->
    <label for="Category">Category:</label>
    <select id="activityCategory" name="Categories" size="1" onclick="toggleDropdown(this)">
      <!-- Category options will be populated here by JavaScript -->
    </select>
    <br>
    <br>
    
    <label for="Tags">Tags:</label>
    <select id="activityTagsDropdown" name="Tags" size="1" onclick="toggleDropdown(this)">
      <!-- Category options will be populated here by JavaScript -->
    </select>
    
   
    <input type="text" id="activityDiscounts" placeholder="Special Discounts">
    <input type="text" id="activityDuration" placeholder="Duration">
    <select id="bookingOpen">
      <option value="true">Booking Open</option>
      <option value="false">Booking Closed</option>
    </select>
    <br>
    <button onclick="createActivity()">Create Activity</button>
  </div>

  <script>
    function toggleDropdown(selectElement) {
      // Check if the dropdown is expanded or not
      if (selectElement.size === 1) {
        // Set size to show all options
        selectElement.size = selectElement.options.length;
      } else {
        // Collapse back to showing only one option
        selectElement.size = 1;
      }
  
      // Close the dropdown when it loses focus
      selectElement.addEventListener('blur', function() {
        selectElement.size = 1;
      });
    }
  </script>

  <div id="updateFormContainer" class="update-form">
    <h2>Update Activity</h2>
    <input type="date" id="UpdateActivityName" placeholder="Name">
    <input type="date" id="updateActivityDate" placeholder="Date">
    <input type="time" id="updateActivityTime" placeholder="Time">
    <input type="text" id="updateActivityLocation" placeholder="Location (URL)">
    <button onclick="getCoordinates(true)">Get Coordinates</button> <!-- Button to get coordinates for update -->
    <div id="updateMap"></div> <!-- Update map div -->
    <input type="text" id="updateActivityPrice" placeholder="Price"> <!-- Changed to text -->
    <select id="updateActivityCategory">
      <option value="">Select Category</option>
    </select>
    <input type="text" id="updateActivityTags" placeholder="Tags (comma separated)">
    <input type="text" id="updateActivityDiscounts" placeholder="Special Discounts">
    <input type="text" id="UpdateActivityDuration" placeholder="Duration">
    <select id="updateBookingOpen">
      <option value="true">Booking Open</option>
      <option value="false">Booking Closed</option>
    </select>
    <button onclick="updateActivity()">Update Activity</button>
  </div>

  <script>
    // Function to fetch categories and populate the dropdown
async function fetchCategories() {
  try {
    const response = await fetch('http://localhost:8000/api/category/getCategories'); // Ensure the API URL is correct
    if (!response.ok) {
      throw new Error(`Failed to fetch categories: ${response.status}`);
    }

    const categories = await response.json();

    const categoryDropdown = document.getElementById('activityCategory');
    const updateCategoryDropdown = document.getElementById('updateActivityCategory');

    // Clear any existing options
    categoryDropdown.innerHTML = '<option value="">Select Category</option>';
    updateCategoryDropdown.innerHTML = '<option value="">Select Category</option>';

    // Populate the dropdowns with categories
    categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category._id;  // Use the category ID as the value
      option.text = category.name;  // Use the category name as the text
      categoryDropdown.appendChild(option);

      // Also add to the update dropdown
      const updateOption = document.createElement('option');
      updateOption.value = category._id;
      updateOption.text = category.name;
      updateCategoryDropdown.appendChild(updateOption);
    });
  } catch (error) {
    console.error('Error fetching categories:', error);
  }
}
document.addEventListener('DOMContentLoaded', fetchCategories);

async function fetchTags() {
  try {
    const response = await fetch('http://localhost:8000/api/prefrenceTag/getpreferenceTags'); // Ensure the API URL is correct for fetching tags
    if (!response.ok) {
      throw new Error(`Failed to fetch tags: ${response.status}`);
    }

    const tags = await response.json();

    const tagDropdown = document.getElementById('activityTagsDropdown'); // Make sure this ID exists in your HTML
    const updateTagDropdown = document.getElementById('updateActivityTagsDropdown'); // Make sure this ID exists in your HTML

    // Clear any existing options
    tagDropdown.innerHTML = '<option value="">Select Tags</option>';
    updateTagDropdown.innerHTML = '<option value="">Select Tags</option>';

    // Populate the dropdowns with tags
    tags.forEach(tag => {
      const option = document.createElement('option');
      option.value = tag._id;  // Use the tag ID as the value
      option.text = tag.name;  // Use the tag name as the text
      tagDropdown.appendChild(option);

      // Also add to the update dropdown
      const updateOption = document.createElement('option');
      updateOption.value = tag._id;
      updateOption.text = tag.name;
      updateTagDropdown.appendChild(updateOption);
    });
  } catch (error) {
    console.error('Error fetching tags:', error);
  }
}

// Call fetchTags when the page loads
document.addEventListener('DOMContentLoaded', fetchTags);



// Call fetchCategories when the page loads

    let currentActivityId = null; // To hold the current activity ID for updates
    let map; // Map variable for creating Google Map instance
    let geocoder; // Geocoder for converting location to coordinates

    // Initialize the Google Map
    function initMap() {
      geocoder = new google.maps.Geocoder(); // Initialize Geocoder
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 43.4142989, lng: -124.2301242 }, // Default center (can be adjusted)
        zoom: 4,
      });
    }

    // Function to get coordinates from the location input
    function getCoordinates(isUpdate = false) {
      const locationInput = isUpdate ? document.getElementById('updateActivityLocation').value : document.getElementById('activityLocation').value;
      geocoder.geocode({ 'address': locationInput }, (results, status) => {
        if (status === 'OK') {
          const location = results[0].geometry.location;
          const mapElement = isUpdate ? document.getElementById('updateMap') : document.getElementById('map');

          // Center the map on the new location
          const newMap = new google.maps.Map(mapElement, {
            center: location,
            zoom: 15,
          });
          new google.maps.Marker({
            position: location,
            map: newMap,
          });

          // Set latitude and longitude as the location value
          const coords = `${location.lat()}, ${location.lng()}`;
          if (!isUpdate) {
            document.getElementById('activityLocation').value = coords; // Set latitude and longitude
          } else {
            document.getElementById('updateActivityLocation').value = coords; // Set latitude and longitude for update
          }
        } else {
          alert('Geocode was not successful for the following reason: ' + status);
        }
      });
    }

    // Function to fetch Activities
  // Function to fetch Activities
  async function fetchActivities() {
  console.log("fetchActivities function called");
  try {
    const response = await fetch('http://localhost:8000/api/activity/getActivity'); // Fetch data from the API
    console.log('Response status:', response.status);
    const data = await response.json();
    console.log('Data:', data); // Parse the response to JSON

    const container = document.getElementById('activityContainer');
    container.innerHTML = ''; // Clear any existing data

    if (response.ok && data.length > 0) {
      data.forEach(activity => {
        const activityElement = document.createElement('div');
        activityElement.className = 'activity';

        // Handle tags: If `tags` is not an array, convert it to an array
        let tags = activity.tags;
        if (!Array.isArray(tags)) {
          tags = [tags]; // Convert to array if it's a single object
        }

        // Creating elements dynamically for each activity
        activityElement.innerHTML = `
          <h2>${activity.name}</h2>
          <p>${new Date(activity.date).toLocaleDateString()} ${activity.time}</p>
          <p>Location: <a href="${activity.location}" target="_blank">${activity.location}</a></p>
          <p>Price: ${activity.price}</p>
          <p>Category:${activity.category ? activity.category.name : 'N/A'}</p>
          <p>Tags: ${tags && tags.length > 0 ? tags.map(tag => tag.name).join(', ') : 'None'}</p>
          <p>Special Discounts: ${activity.specialDiscounts}</p>
          <p><strong>Booking Open: ${activity.bookingOpen ? 'Yes' : 'No'}</strong></p>
          <button class="delete-button" onclick="deleteActivity('${activity._id}')">Delete Activity</button>
          <button class="update-button" onclick="showUpdateForm('${activity._id}')">Update Activity</button>
        `;

        container.appendChild(activityElement);
      });
    } else {
      container.innerHTML = '<p>No activities found.</p>';
    }
  } catch (error) {
    console.error('Error fetching activities:', error);
  }
}

    // Function to create a new activity
    async function createActivity() {
      console.log("createActivity function called");
      const activityData = {
        date: document.getElementById('activityDate').value,
        time: document.getElementById('activityTime').value,
        location: document.getElementById('activityLocation').value,
        price: document.getElementById('activityPrice').value,
        category: { name: document.getElementById('activityCategory').value },
        tags: document.getElementById('activityTags').value.split(',').map(tag => ({ name: tag.trim() })),
        specialDiscounts: document.getElementById('activityDiscounts').value,
        bookingOpen: document.getElementById('bookingOpen').value === 'true',
      };

      try {
        const response = await fetch('http://localhost:8000/api/activity/createActivity', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(activityData),
        });
        if (response.ok) {
          alert('Activity created successfully!');
          fetchActivities(); // Refresh the activity list
          toggleCreateForm(); // Hide the create form
        } else {
          alert('Failed to create activity.');
        }
      } catch (error) {
        console.error('Error creating activity:', error);
      }
    }

    // Function to delete an activity
    async function deleteActivity(id) {
      console.log("deleteActivity function called with id:", id);
      try {
        const response = await fetch(`http://localhost:8000/api/activity/deleteActivity/${id}`, {
          method: 'DELETE',
        });
        if (response.ok) {
          alert('Activity deleted successfully!');
          fetchActivities(); // Refresh the activity list
        } else {
          alert('Failed to delete activity.');
        }
      } catch (error) {
        console.error('Error deleting activity:', error);
      }
    }

    // Function to show update form
    async function showUpdateForm(id) {
      console.log("showUpdateForm function called with id:", id);
      currentActivityId = id; // Store the activity ID to update

      const response = await fetch(`http://localhost:8000/api/activity/getActivity/${id}`);
      const activity = await response.json();

      // Fill the update form with the activity data
      document.getElementById('updateActivityDate').value = activity.date.split('T')[0]; // Date format adjustment
      document.getElementById('updateActivityTime').value = activity.time;
      document.getElementById('updateActivityLocation').value = activity.location; // Will get coordinates
      document.getElementById('updateActivityPrice').value = activity.price;
      document.getElementById('updateActivityCategory').value = activity.category.name;
      document.getElementById('updateActivityTags').value = activity.tags.map(tag => tag.name).join(', ');
      document.getElementById('updateActivityDiscounts').value = activity.specialDiscounts;
      document.getElementById('updateBookingOpen').value = activity.bookingOpen ? 'true' : 'false';

      toggleUpdateForm(); // Show update form
    }

    // Function to toggle the create form visibility
    function toggleCreateForm() {
      const createFormContainer = document.getElementById('createFormContainer');
      createFormContainer.style.display = createFormContainer.style.display === 'none' ? 'block' : 'none';
    }

    // Function to toggle the update form visibility
    function toggleUpdateForm() {
      const updateFormContainer = document.getElementById('updateFormContainer');
      updateFormContainer.style.display = updateFormContainer.style.display === 'none' ? 'block' : 'none';
    }

    // Function to update an activity
    async function updateActivity() {
      console.log("updateActivity function called");
      const updatedData = {
        date: document.getElementById('updateActivityDate').value,
        time: document.getElementById('updateActivityTime').value,
        location: document.getElementById('updateActivityLocation').value,
        price: document.getElementById('updateActivityPrice').value,
        category: { name: document.getElementById('updateActivityCategory').value },
        tags: document.getElementById('updateActivityTags').value.split(',').map(tag => ({ name: tag.trim() })),
        specialDiscounts: document.getElementById('updateActivityDiscounts').value,
        bookingOpen: document.getElementById('updateBookingOpen').value === 'true',
      };

      try {
        const response = await fetch(`http://localhost:8000/api/activity/updateActivity/${currentActivityId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedData),
        });
        if (response.ok) {
          alert('Activity updated successfully!');
          fetchActivities(); // Refresh the activity list
          toggleUpdateForm(); // Hide the update form
        } else {
          alert('Failed to update activity.');
        }
      } catch (error) {
        console.error('Error updating activity:', error);
      }
    }
  </script>
</body>
</html>
