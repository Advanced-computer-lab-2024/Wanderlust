<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tour Guide Itinerary</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    nav {
      background-color: #333;
      padding: 10px;
      margin-bottom: 20px;
    }

    nav a {
      color: white;
      text-decoration: none;
      padding: 10px;
      margin-right: 10px;
      display: inline-block;
    }

    nav a:hover {
      background-color: #575757;
      border-radius: 4px;
    }

    .itinerary {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .activity {
      margin: 10px 0;
    }

    .activity h3 {
      margin: 0;
    }

    .delete-button {
      background-color: #ff4d4d;
      color: white;
      border: none;
      padding: 8px;
      cursor: pointer;
      border-radius: 4px;
    }

    .delete-button:hover {
      background-color: #ff1a1a;
    }

    .update-form {
      display: none;
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .update-form input, .update-form select {
      width: 100%;
      margin: 5px 0;
      padding: 8px;
    }

    .update-button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px;
      cursor: pointer;
      border-radius: 4px;
    }

    .update-button:hover {
      background-color: #45a049;
    }
  </style>
<script
async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjbAAKNhaUHHM7DmvEdWNVJqC2iDQtrG4&callback=initMap&libraries=places"
></script></head>
<body>

  <script>(g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})
  ({key: "AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg", v: "weekly"});</script>
  

  <nav>
    <a>Tour Guide</a>
    <a href="tourguide_profile.html">Profile</a>
    <a href="tourguide_Itinerary.html">Itinerary</a>
    <a href="Main.html">Back to Main Page</a>
  </nav>

  <h1>Tour Guide Itinerary</h1>

  <button id="toggleCreateFormButton" >Create New Itinerary</button>

  <div id="createFormContainer" class="create-form" style="display:none;">
    
    <h2>Create New Itinerary</h2>
    <form id="createItineraryForm">
      <label for="title">Title:</label>
      <input type="text" id="createTitle" name="title" required>
      
      <!-- Dropdown for selecting activities -->
      <label for="activities">Select Activities:</label>
      <select id="createActivities" name="activities" multiple size="5" required>
        <!-- Your options here -->
        <option value="1">Activity 1</option>
        <option value="2">Activity 2</option>
        <option value="3">Activity 3</option>
        <option value="4">Activity 4</option>
        <option value="5">Activity 5</option>
      </select>
    
      <script>
     document.addEventListener('DOMContentLoaded', function () {
  const selectElement = document.getElementById('createActivities');

  // Handle mousedown instead of click to prevent default behavior
  selectElement.addEventListener('mousedown', function(event) {
    event.preventDefault(); // Prevent the default behavior
    const option = event.target;

    // Toggle selection state manually
    if (option.tagName === 'OPTION') {
      option.selected = !option.selected;
    }
  });
});
document.addEventListener('DOMContentLoaded', function () {
  const selectElement = document.getElementById('updateActivities');

  // Handle mousedown instead of click to prevent default behavior
  selectElement.addEventListener('mousedown', function(event) {
    event.preventDefault(); // Prevent the default behavior
    const option = event.target;

    // Toggle selection state manually
    if (option.tagName === 'OPTION') {
      option.selected = !option.selected;
    }
  });
});
        </script>
    
      
      
      <label for="locations">Locations (comma separated):</label>
      <input type="text" id="createLocations" name="locations" required>
      
      <label for="timelineStart">Timeline Start:</label>
      <input type="datetime-local" id="createTimelineStart" name="timeline.start" required>
      
      <label for="timelineEnd">Timeline End:</label>
      <input type="datetime-local" id="createTimelineEnd" name="timeline.end" required>
      
      <label for="languageOfTour">Language of Tour:</label>
      <input type="text" id="createLanguageOfTour" name="languageOfTour" required>
      
      <label for="price">Price:</label>
      <input type="number" id="createPrice" name="price" required>
      
      <label for="availableDates">Available Dates (comma separated):</label>
      <input type="text" id="createAvailableDates" name="availableDates" required>
      
      <label for="accessibility">Accessibility:</label>
      <input type="text" id="createAccessibility" name="accessibility" required>
      
      <label for="pickupLocation">Pickup Location:</label>
      <input type="text" id="createPickupLocation" name="pickupLocation" required>
      
      <label for="dropoffLocation">Dropoff Location:</label>
      <input type="text" id="createDropoffLocation" name="dropoffLocation" required>
      
      <button type="submit" class="create-button">Create Itinerary</button>
    </form>
  </div>

  <div id="itineraryContainer">
    <!-- Itinerary content will be loaded here -->
  </div>

  <button id="toggleUpdateButton" style="display:none;" onclick="toggleUpdateForm(itinerary)">Edit Itinerary</button>
   <div id="updateFormContainer" class="update-form" style="display:none;"> 
    <h2>Update Itinerary</h2>
    <form id="updateItineraryForm">
      <label for="updateTitle">Title:</label>
      <input type="text" id="updateTitle" name="title" required>
      
      <label for="updateActivities">Select Activities:</label>
      <select id="updateActivities" name="activities" multiple size="5" required>
        <!-- Options will be populated dynamically -->
      </select>
      
      <label for="updateLocations">Locations (comma separated):</label>
      <input type="text" id="updateLocations" name="locations" required>
      
      <label for="updateTimelineStart">Timeline Start:</label>
      <input type="datetime-local" id="updateTimelineStart" name="timeline.start" required>
      
      <label for="updateTimelineEnd">Timeline End:</label>
      <input type="datetime-local" id="updateTimelineEnd" name="timeline.end" required>
      
      <label for="updateLanguageOfTour">Language of Tour:</label>
      <input type="text" id="updateLanguageOfTour" name="languageOfTour" required>
      
      <label for="updatePrice">Price:</label>
      <input type="number" id="updatePrice" name="price" required>
      
      <label for="updateAvailableDates">Available Dates (comma separated):</label>
      <input type="text" id="updateAvailableDates" name="availableDates" required>
      
      <label for="updateAccessibility">Accessibility:</label>
      <input type="text" id="updateAccessibility" name="accessibility" required>
      
      <label for="updatePickupLocation">Pickup Location:</label>
      <input type="text" id="updatePickupLocation" name="pickupLocation" required>
      
      <label for="updateDropoffLocation">Dropoff Location:</label>
      <input type="text" id="updateDropoffLocation" name="dropoffLocation" required>
      
      <button type="submit" class="update-button">Update Itinerary</button>
      <button type="button" id="cancelUpdateButton">Cancel</button>
    </form>
  </div>
  <script>

function initMap() {
      geocoder = new google.maps.Geocoder(); // Initialize Geocoder
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 43.4142989, lng: -124.2301242 }, // Default center (can be adjusted)
        zoom: 4,
      });
    }
function handleUpdateClick(itinerary) {
  toggleUpdateForm(itinerary);
}


window.onerror = function(message, source, lineno, colno, error) {
  console.error('An error occurred:', message, 'at', source, 'line', lineno);
  alert('An error occurred. Please check the console for more details.');
};
    
// Function to toggle the update itinerary form visibility
// Global variable to store the currently selected itinerary
let selectedItinerary = null;

// Function to toggle the update itinerary form visibility
// Function to toggle the update itinerary form visibility
// Function to toggle the update itinerary form visibility
// Function to toggle the update itinerary form visibility
function toggleUpdateForm(id) {
  const updateFormContainer = document.getElementById('updateFormContainer');
  const itinerary = itineraries.find(itinerary => itinerary._id === id);

  if (updateFormContainer.style.display === 'none' || updateFormContainer.style.display === '') {
    selectedItinerary = itinerary; // Set the selectedItinerary variable

    // Populate form fields
    document.getElementById('updateTitle').value = itinerary.title;
    document.getElementById('updateLocations').value = itinerary.locations.join(', ');
    document.getElementById('updateTimelineStart').value = new Date(itinerary.timeline.start).toISOString().slice(0, 16);
    document.getElementById('updateTimelineEnd').value = new Date(itinerary.timeline.end).toISOString().slice(0, 16);
    document.getElementById('updateLanguageOfTour').value = itinerary.languageOfTour;
    document.getElementById('updatePrice').value = itinerary.price;
    document.getElementById('updateAvailableDates').value = itinerary.availableDates.join(', ');
    document.getElementById('updateAccessibility').value = itinerary.accessibility;
    document.getElementById('updatePickupLocation').value = itinerary.pickupLocation;
    document.getElementById('updateDropoffLocation').value = itinerary.dropoffLocation;

    // Fetch all activities from the API
    fetch('http://localhost:8000/api/activity/getActivity')
      .then(response => response.json())
      .then(activities => {
        // Populate activities dropdown
        const activitiesDropdown = document.getElementById('updateActivities');
        activitiesDropdown.innerHTML = ''; // Clear existing options

        activities.forEach(activity => {
          const option = document.createElement('option');
          option.value = activity._id;
          option.text = activity.name;

          // Pre-select the activities that are already part of the itinerary
          if (itinerary.activities.find(a => a._id === activity._id)) {
            option.selected = true;
          }

          activitiesDropdown.appendChild(option);
        });
      })
      .catch(error => console.error('Error fetching activities:', error));

    updateFormContainer.style.display = 'block';
  } else {
    updateFormContainer.style.display = 'none';
    selectedItinerary = null;
  }
}


// Add event listener to the update button
document.getElementById('toggleUpdateButton').addEventListener('click', function() {
  toggleUpdateForm(itinerary._id); // Pass the itinerary ID to the toggleUpdateForm function
});

// Add event listener to cancel button
document.getElementById('cancelUpdateButton').addEventListener('click', function() {
  document.getElementById('updateFormContainer').style.display = 'none';
});



// Function to handle form submission for updating an itinerary
document.getElementById('updateItineraryForm').addEventListener('submit', async function(event) {
  event.preventDefault();

  if (!selectedItinerary) {
    alert('No itinerary selected for update.');
    return;
  }

  const id = selectedItinerary._id;
  const title = document.getElementById('updateTitle').value;
  const activities = Array.from(document.getElementById('updateActivities').selectedOptions).map(option => option.value);
  const locations = document.getElementById('updateLocations').value.split(',').map(location => location.trim());
  const timeline = {
    start: new Date(document.getElementById('updateTimelineStart').value).toISOString(),
    end: new Date(document.getElementById('updateTimelineEnd').value).toISOString()
  };
  const languageOfTour = document.getElementById('updateLanguageOfTour').value;
  const price = parseFloat(document.getElementById('updatePrice').value);
  const availableDates = document.getElementById('updateAvailableDates').value.split(',').map(date => date.trim());
  const accessibility = document.getElementById('updateAccessibility').value;
  const pickupLocation = document.getElementById('updatePickupLocation').value;
  const dropoffLocation = document.getElementById('updateDropoffLocation').value;

  const data = {
    id,
    title,
    activities,
    locations,
    timeline,
    languageOfTour,
    price,
    availableDates,
    accessibility,
    pickupLocation,
    dropoffLocation
  };

  try {
    const response = await fetch(`http://localhost:8000/updateItinerary`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    });

    const result = await response.json();

    if (response.ok) {
      alert('Itinerary updated successfully!');
      fetchItineraries();
      toggleUpdateForm();
    } else {
      console.error('Error:', result.error);
      alert('Failed to update itinerary: ' + result.error);
    }
  } catch (error) {
    console.error('Error:', error);
    alert('An error occurred while updating the itinerary.');
  }
});


    // Function to toggle the create itinerary form visibility
function toggleCreateForm() {
  const formContainer = document.getElementById('createFormContainer');
  const toggleButton = document.getElementById('toggleCreateFormButton');
  
  if (formContainer.style.display === 'none') {
    formContainer.style.display = 'block';
    toggleButton.textContent = 'Hide Create Itinerary Form';
  } else {
    formContainer.style.display = 'none';
    toggleButton.textContent = 'Create New Itinerary';
  }
}





// Add an event listener to the button to trigger the toggle function
document.getElementById('toggleCreateFormButton').addEventListener('click', toggleCreateForm);
    // Function to fetch itinerary data from the API
    let globalItinerary;

// Function to fetch itinerary data from the API
// Function to fetch itinerary data from the API
async function fetchItineraries() {
  try {
    const response = await fetch('http://localhost:8000/getItinerary'); // Adjust the API endpoint as needed
    const data = await response.json();
    const container = document.getElementById('itineraryContainer');
    container.innerHTML = '';

    if (response.ok && data.length > 0) {
      itineraries = data; // Store the itinerary objects in an array

      data.forEach(itinerary => {
        const itineraryElement = document.createElement('div');
        itineraryElement.className = 'itinerary';

        // Build activities list dynamically
        const activitiesHTML = itinerary.activities.map((activity, index) => `
          <div class="activity">
            <h4>${new Date(activity.date).toLocaleDateString()} at ${activity.time}</h4>
            <p><strong>Activity Name:</strong> ${activity.name}</p>

            <p>Price: ${activity.price}</p>
            <p><strong>Category:</strong> ${activity.category.name}</p>
            <p><strong>Tags:</strong> ${Array.isArray(activity.tags) ? activity.tags.map(tag => tag.name).join(', ') : activity.tags.name}</p>
            <p>Special Discounts: ${activity.specialDiscounts}</p>
            <p><strong>Booking Open:</strong> ${activity.bookingOpen ? 'Yes' : 'No'}</p>
            <div class="map" id="map-${itinerary._id}-${index}" style="height: 200px; width: 300px;"></div>
          </div>
        `).join('');

        // Render the itinerary details
        itineraryElement.innerHTML = `
          <h2>${itinerary.title}</h2>
          <p><strong>Timeline:</strong> ${new Date(itinerary.timeline.start).toLocaleString()} to ${new Date(itinerary.timeline.end).toLocaleString()}</p>
          <p><strong>Price:</strong> $${itinerary.price}</p>
          <p><strong>Language of Tour:</strong> ${itinerary.languageOfTour}</p>
          <p><strong>Locations:</strong> ${itinerary.locations.join(', ')}</p>
          <p><strong>Available Dates:</strong> ${itinerary.availableDates.join(', ')}</p>
          <h3>Activities:</h3>
          ${activitiesHTML} <!-- Dynamically inserted activities -->
          <p><strong>Accessibility:</strong> ${itinerary.accessibility}</p>
          <p><strong>Pickup Location:</strong> ${itinerary.pickupLocation}</p>
          <p><strong>Dropoff Location:</strong> ${itinerary.dropoffLocation}</p>
          <button class="delete-button" onclick="deleteItinerary('${itinerary._id}')">Delete Itinerary</button>
          <button class="update-button" onclick="toggleUpdateForm('${itinerary._id}')">Update Itinerary</button>
        `;

        container.appendChild(itineraryElement);

        // Initialize Google Map for each activity
        itinerary.activities.forEach((activity, index) => {
          const mapElement = document.getElementById(`map-${itinerary._id}-${index}`);
          const map = new google.maps.Map(mapElement, {
            center: { lat: activity.lat, lng: activity.lng },
            zoom: 15,
          });
          new google.maps.Marker({
            position: { lat: activity.lat, lng: activity.lng },
            map: map,
          });
        });
      });
    } else {
      container.innerHTML = '<p>No itineraries available at the moment.</p>';
    }
  } catch (error) {
    console.error('Error fetching itineraries:', error);
    document.getElementById('itineraryContainer').innerHTML = '<p>Failed to load itineraries.</p>';
  }
}  // Function to delete an itinerary
    async function deleteItinerary(id) {
  try {
    const response = await fetch(`http://localhost:8000/deleteItinerary`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json' // Ensure you're sending JSON data
      },
      body: JSON.stringify({ id }) // Send the id in the request body
    });

    if (response.ok) {
      fetchItineraries(); // Refresh the itinerary list after deletion
    } else {
      const errorData = await response.json();
      console.error('Error deleting itinerary:', errorData.error);
      alert('Failed to delete itinerary: ' + errorData.error);
    }
  } catch (error) {
    console.error('Error deleting itinerary:', error);
    alert('Failed to delete itinerary.');
  }
}
    // Function to open the update form and populate it with existing data
    
function getItineraryById(id) {
  const itineraries = JSON.parse(localStorage.getItem('itineraries')) || [];
  return itineraries.find(itinerary => itinerary._id === id);
}

    // Function to handle form submission for updating an itinerary
    document.getElementById('updateItineraryForm').addEventListener('submit', async (event) => {
      event.preventDefault(); // Prevent default form submission

      const id = document.getElementById('itineraryId').value;
      const title = document.getElementById('title').value;
      const locations = document.getElementById('locations').value.split(',').map(loc => loc.trim());
      const timeline = {
        start: new Date(document.getElementById('timelineStart').value).toISOString(),
        end: new Date(document.getElementById('timelineEnd').value).toISOString()
      };
      const languageOfTour = document.getElementById('languageOfTour').value;
      const price = parseFloat(document.getElementById('price').value);
      const availableDates = document.getElementById('availableDates').value.split(',').map(date => date.trim());
      const accessibility = document.getElementById('accessibility').value;
      const pickupLocation = document.getElementById('pickupLocation').value;
      const dropoffLocation = document.getElementById('dropoffLocation').value;

      const response = await fetch(`http://localhost:8000/updateItinerary`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id, title, activities, locations, timeline, languageOfTour, price, availableDates, accessibility, pickupLocation, dropoffLocation }),
      });

      if (response.ok) {
        alert('Itinerary updated successfully!');
        fetchItineraries(); // Refresh the itinerary list after updating
        toggleUpdateForm(); // Hide the update form
      } else {
        const errorData = await response.json();
        console.error('Error updating itinerary:', errorData.error);
        alert('Failed to update itinerary: ' + errorData.error);
      }
    });

    // Call the function to fetch itineraries when the page loads
    document.addEventListener('DOMContentLoaded', fetchItineraries);

    document.getElementById('createItineraryForm').addEventListener('submit', async function(event) {
  event.preventDefault(); // Prevent the form from submitting the traditional way

  // Get values from the form fields
  const title = document.getElementById('createTitle').value;
  const activities = Array.from(document.getElementById('createActivities').selectedOptions).map(option => option.value);
  const locations = document.getElementById('createLocations').value.split(',').map(location => location.trim());
  const timeline = {
    start: new Date(document.getElementById('createTimelineStart').value).toISOString(),
    end: new Date(document.getElementById('createTimelineEnd').value).toISOString()
  };
  const languageOfTour = document.getElementById('createLanguageOfTour').value;
  const price = parseFloat(document.getElementById('createPrice').value);
  const availableDates = document.getElementById('createAvailableDates').value.split(',').map(date => date.trim());
  const accessibility = document.getElementById('createAccessibility').value;
  const pickupLocation = document.getElementById('createPickupLocation').value;
  const dropoffLocation = document.getElementById('createDropoffLocation').value;

  // Create the data object to send
  const data = {
    title,
    activities,  
    locations,
    timeline,
    languageOfTour,
    price,
    availableDates,
    accessibility,
    pickupLocation,
    dropoffLocation
  };

  try {
    // Send the data to the server using fetch
    const response = await fetch('http://localhost:8000/createItinerary', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    });

    const result = await response.json();

    if (response.ok) {
      alert('Itinerary created successfully!');
      fetchItineraries(); // Optionally refresh the itineraries list
    } else {
      console.error('Error:', result.error);
      alert('Failed to create itinerary: ' + result.error);
    }
  } catch (error) {
    console.error('Error:', error);
    alert('An error occurred while creating the itinerary.');
  }
});
  // Function to fetch activities and populate the dropdown using the existing /getActivity API
  async function fetchActivities() {
    try {
      const response = await fetch('http://localhost:8000/api/activity/getActivity');
      const activities = await response.json();

      const activitiesDropdown = document.getElementById('createActivities');
      activitiesDropdown.innerHTML = '';

      if (response.ok && activities.length > 0) {
        activities.forEach(activity => {
          const option = document.createElement('option');
          option.value = activity._id;
          option.text = activity.name;
          activitiesDropdown.appendChild(option);
        });
      } else {
        activitiesDropdown.innerHTML = '<option>No activities available</option>';
      }
    } catch (error) {
      console.error('Error fetching activities:', error);
    }
  }

  document.addEventListener('DOMContentLoaded', fetchActivities);

  console.log("End of script reached");
</script>

</body>
</html>